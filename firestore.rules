rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * FIRESTORE SECURITY RULES
     * 
     * Core Philosophy:
     * This ruleset implements a strict User-Ownership model. Access is restricted to 
     * authenticated users managing their own subscription data.
     * 
     * Data Structure:
     * The primary data resides in the `/emails` collection, where the document ID
     * corresponds to the user's authenticated UID.
     */

    // --- GLOBAL HELPER FUNCTIONS ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return resource != null && isOwner(userId);
    }

    // --- COLLECTION RULES ---

    match /emails/{emailId} {
      /**
       * @description Rules for managing user newsletter subscriptions.
       * Users can only read, create, or update their own subscription record.
       */
      allow get: if isOwner(emailId);
      allow list: if isOwner(emailId);
      
      // Ensure the 'id' field in the document matches the document ID (UID)
      allow create: if isOwner(emailId) && request.resource.data.id == emailId;
      
      // Ensure ownership is maintained during updates
      allow update: if isExistingOwner(emailId) && request.resource.data.id == resource.data.id;
      
      allow delete: if isExistingOwner(emailId);
    }

    // --- DEFAULT DENY ---
    match /{path=**} {
      allow read, write: if false;
    }
  }
}